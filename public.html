<!DOCTYPE html>
<html>

<head>
  <title>Nursery Scheduler</title>
  <meta charset='utf-8' />
  <script type="text/javascript" src="nurse.js"></script>
  <script type="text/javascript" src="week.js"></script>


</head>

<body>
  <p>Projekt Grupowy</p>

  <!--Add buttons to initiate auth sequence and sign out-->
  <button id="authorize-button" style="display: none;">Autoryzacja</button>
  <button id="signout-button" style="display: none;">Wyloguj sie</button>

  <button id="add-button" onclick="addEvents()">Dodaj</button>
  <button id="clear-button" onclick="clearEvents()">Usun wszystkie rekordy</button>
  <button id="list-button" onclick="listUpcomingEvents()">Wylistuj obecny grafik</button>

  <pre id="content"></pre>

  <script type="text/javascript">

    var D_begin = '08:00';
    var D_end = '17:00';
    var E_begin = '07:00';
    var E_end = '16:00';
    var L_begin = '14:00';
    var L_end = '23:00';
    var N_begin = '23:00';
    var N_end = '07:00';
    // Client ID and API key from the Developer Console
    var CLIENT_ID = '1047768627-vpslilg9obi5s5r87qfnsa56dmu44f0m.apps.googleusercontent.com';
    var API_KEY = 'AIzaSyB9WVA1vqVrBo_5gWsWy6ZJucdo-OL9lEY';
    var CAL_ID = 'mieulsd7alt7nv54npe75e9eug@group.calendar.google.com';

    // Array of API discovery doc URLs for APIs used by the quickstart
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    var SCOPES = "https://www.googleapis.com/auth/calendar";

    var authorizeButton = document.getElementById('authorize-button');
    var signoutButton = document.getElementById('signout-button');



    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
      gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
      gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
      }).then(function () {
        // Listen for sign-in state changes.
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state.
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
      });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
      if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
        listUpcomingEvents();
      } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
      }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
      gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
      gapi.auth2.getAuthInstance().signOut();
    }

    /**
     * Append a pre element to the body containing the given message
     * as its text node. Used to display the results of the API call.
     *
     * @param {string} message Text to be placed in pre element.
     */
    function appendPre(message) {
      var pre = document.getElementById('content');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }

    /**
     * Print the summary and start datetime/date of the next ten events in
     * the authorized user's calendar. If no events are found an
     * appropriate message is printed.
     */
    function listUpcomingEvents() {
      gapi.client.calendar.events.list({
        'calendarId': CAL_ID,
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 2000,
        'orderBy': 'startTime'
      }).then(function (response) {
        var events = response.result.items;
        appendPre('Grafik:');

        if (events.length > 0) {
          for (i = 0; i < events.length; i++) {
            var event = events[i];
            var when = event.start.dateTime;
            if (!when) {
              when = event.start.date;
            }
            appendPre(event.summary + ' (' + when + ')')
          }
        } else {
          appendPre('Nie znaleziono grafiku.');
        }
      });
    }

    function addEvents() {

      var l_pielegniarek = 16;
      var l_dni = 35;
      var nurse1 = new Nurse(1);
      var nurse2 = new Nurse(2);
      var nurse3 = new Nurse(3);
      var nurse4 = new Nurse(4);
      var nurse5 = new Nurse(5);
      var nurse6 = new Nurse(6);
      var nurse7 = new Nurse(7);
      var nurse8 = new Nurse(8);
      var nurse9 = new Nurse(9);
      var nurse10 = new Nurse(10);
      var nurse11 = new Nurse(11);
      var nurse12 = new Nurse(12);
      var nurse13 = new Nurse(13);
      var nurse14 = new Nurse(14);
      var nurse15 = new Nurse(15);
      var nurse16 = new Nurse(16);

      var NursesArray = new Array();
      NursesArray.push(nurse1);
      NursesArray.push(nurse2);
      NursesArray.push(nurse3);
      NursesArray.push(nurse4);
      NursesArray.push(nurse5);
      NursesArray.push(nurse6);
      NursesArray.push(nurse7);
      NursesArray.push(nurse8);
      NursesArray.push(nurse9);
      NursesArray.push(nurse10);
      NursesArray.push(nurse11);
      NursesArray.push(nurse12);
      NursesArray.push(nurse13);
      NursesArray.push(nurse14);
      NursesArray.push(nurse15);
      NursesArray.push(nurse16);


      //Pierwsza pielegniarka nie moze pracowac w nocy
      NursesArray[0].canWorkAtNight = false;
      //13 pielegniarka pracuje 32 godziny

      for (var j = 0; j < NursesArray.length; j++) {

        //inicjalizacja parametrow pielegniarek
        NursesArray[j].consecutiveShifts = 0;
        NursesArray[j].consecutiveNights = 0;
        NursesArray[j].workedHours = 0;
        NursesArray[j].restHours = 0;
        NursesArray[j].workedToday = false;
        NursesArray[j].workedYesterday = false;
        NursesArray[j].weekendsOffDuty = 0;
        NursesArray[j].entireWorkedHours = 0;



        if (j == 12) {
          NursesArray[j].maxHours = 32;
        }
        else if (j == 13 || j == 14 || j == 15) {
          //3 ostatnie pielegniarki pracuja 20 godzin
          NursesArray[j].maxHours = 20;
        }
        else {
          NursesArray[j].maxHours = 36;
        }
      }


      var today = new Date();
      var x = 6 - today.getDay() + 1;
      today.setDate(today.getDate() + x);
      console.log(today.getDay() + ' ' + today.getDate() + x);

      var batch = gapi.client.newBatch();
      var batchCounter = 0;
      //shuffle(NursesArray);



      for (var i = 0; i < l_dni; i++) {

        var tomorrow = new Date();
        tomorrow.setDate(today.getDate() + i + 1); //Iteracja po kolejnych dniach od kolejnego tygodnia
        var month = tomorrow.getMonth() + 1; //pobieramy numer miesiaca
        var dayOfWeek = tomorrow.getDay() + 1; //numer dnia tygodnia
        var dayOfMonth = tomorrow.getDate();
        var count = 0;
        var day = new WorkDay();

        if (dayOfWeek == 1 || dayOfWeek == 2 || dayOfWeek == 3 || dayOfWeek == 4 || dayOfWeek == 5) {
          day = new WorkDay();
          day.D_demand = 3;
          day.E_demand = 3;
          day.L_demand = 3;
          day.N_demand = 1;
        }
        else if (dayOfWeek == 6 || dayOfWeek == 7) {
          day = new Weekend();
          day.D_demand = 2;
          day.E_demand = 2;
          day.L_demand = 2;
          day.N_demand = 1;
        }




        //generating E shift
        for (var j = 0; j < NursesArray.length; j++) {
          if (checkNurse(NursesArray[j], dayOfWeek, 2)) {
            var event = createEventString(j, month, dayOfMonth, dayOfMonth, E_begin, E_end, 2);
            batch.add(gapi.client.calendar.events.insert({
              'calendarId': CAL_ID,
              'resource': event
            }));
            batchCounter++;
            updateChosenNurse(NursesArray[j], 2, dayOfWeek);
            count++;
            if (count >= day.E_demand) {
              count = 0;
              break;
            }
          }
          else NursesArray[j].restHours = NursesArray[j].restHours + 9;
        }

        //generating D shift
        for (var j = 0; j < NursesArray.length; j++) {
          if (checkNurse(NursesArray[j], dayOfWeek, 1)) {
            var event = createEventString(j, month, dayOfMonth, dayOfMonth, D_begin, D_end, 1);
            batch.add(gapi.client.calendar.events.insert({
              'calendarId': CAL_ID,
              'resource': event
            }));
            batchCounter++;

            updateChosenNurse(NursesArray[j], 1, dayOfWeek);
            count++;
            if (count >= day.D_demand) {
              count = 0;
              break;
            }
          }
          else NursesArray[j].restHours = NursesArray[j].restHours + 1;

        }

        //generating L shift
        for (var j = 0; j < NursesArray.length; j++) {
          if (checkNurse(NursesArray[j], dayOfWeek, 3)) {
            var event = createEventString(j, month, dayOfMonth, dayOfMonth, L_begin, L_end, 3);
            batch.add(gapi.client.calendar.events.insert({
              'calendarId': CAL_ID,
              'resource': event
            }));
            batchCounter++;
            updateChosenNurse(NursesArray[j], 3, dayOfWeek);
            count++;
            if (count >= day.L_demand) {
              count = 0;
              break;
            }
          }
          else NursesArray[j].restHours = NursesArray[j].restHours + 6;

        }
        //Night shift
        for (var j = 0; j < NursesArray.length; j++) {
          if (checkNurse(NursesArray[j], dayOfWeek, 4)) {
            var event = createEventString(j, month, dayOfMonth, ++dayOfMonth, N_begin, N_end, 4);
            batch.add(gapi.client.calendar.events.insert({
              'calendarId': CAL_ID,
              'resource': event
            }));
            batchCounter++;
            updateChosenNurse(NursesArray[j], 4, dayOfWeek);
            count++;
            if (count >= day.N_demand) {
              count = 0;
              break;
            }
          }
          else NursesArray[j].restHours = NursesArray[j].restHours + 8;
        }
        for (var j = 0; j < NursesArray.length; j++) {
          //resetujemy na koniec dnia warunek czy dana osoba pracowala
          if (NursesArray[j].workedToday == true) {
            NursesArray[j].workedYesterday = true;
          }
          else NursesArray[j].consecutiveShifts = 0;
          NursesArray[j].workedToday = false;
          if (dayOfWeek == 7) {
            //resetujemy na koniec tygodnia godziny pracy
            NursesArray[j].workedHours = 0;
          }
        }

      }
      if (true) {
        batch.then(function () {
          console.log('Wygenerowano grafik');
        });
      }
      else {
        console.log(batchCounter);
        for (var j = 0; j < NursesArray.length; j++) {
          console.log(NursesArray[j].entireWorkedHours);
        }
      }
    }


    function updateChosenNurse(nurse, shiftCode, dayOfWeek) {
      nurse.workedHours = nurse.workedHours + 8;
      nurse.entireWorkedHours = nurse.entireWorkedHours + 8;
      nurse.consecutiveShifts = nurse.consecutiveShifts + 1;
      nurse.workedToday = true;
      nurse.restHours = 0;


      //consecutive nights
      if (shiftCode == 4) {
        nurse.consecutiveNights = nurse.consecutiveNights + 1;
      }
      else nurse.consecutiveNights = 0;

      //3 consecutive nights
      if (nurse.consecutiveNights > 2) {
        nurse.consecutiveNights = 0;
      }

      // 6 consecutive shifts
      if (nurse.consecutiveShifts > 5) {
        nurse.consecutiveShifts = 0;
      }

      //weekends of duty
      if(dayOfWeek == 7 && nurse.workedYesterday == true){
        nurse.weekendsOffDuty++;
      }
    }


    function checkNurse(nurse, dayOfWeek, shiftCode) {

      
      if (nurse.consecutiveShifts > 5) {
        return false;
      }
      
      else if (nurse.consecutiveNights > 2) {
        return false;
      }
      
      else if (nurse.workedHours >= nurse.maxHours && dayOfWeek != 1) {
        return false;
      }
      
      //TODO •During any period of 24 consecutive hours, at least 11 hours of rest is required.
      else if (nurse.restHours < 11 && nurse.workedYesterday == true) {
        return false;
      }
      else if(nurse.canWorkAtNight == false && shiftCode == 4){
        return false;
      }
    
      else if (nurse.consecutiveNights >= 2 && nurse.restHours >= 42) {
        return false;
      }
      
      else if (nurse.workedToday == true) {
        return false;
      }
      
      else if (nurse.restHours < 14 && shiftCode == 4) {
        return false;
      }
      
      else return true;
    }

    function createEventString(nourseId, month, startingDate, endingDate, shiftBegin, shiftEnd, colorId) {

      var endingMonth = month;
      if (endingDate == 32) {
        endingDate = 1;
        endingMonth = month + 1;
      }
      var event = {
        'summary': 'Pielęgniarka ' + nourseId,
        'location': 'Szpital',
        'description': '//TODO',
        'colorId': colorId,
        'start': {
          'dateTime': '2018-' + month + '-' + startingDate + 'T' + shiftBegin + ':00+02:00'
        },
        'end': {
          'dateTime': '2018-' + endingMonth + '-' + endingDate + 'T' + shiftEnd + ':00+02:00'
        }
      };
      return event;
    }


    function clearEvents() {
      gapi.client.calendar.events.list({
        'calendarId': CAL_ID,
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 2000,
        'orderBy': 'startTime'
      }).then(function (response) {
        var events = response.result.items;
        var batch2 = gapi.client.newBatch();
        console.log(events.length);

        if (events.length > 0) {
          for (i = 0; i < events.length; i++) {
            var event = events[i];
            console.log(i);
            batch2.add(gapi.client.calendar.events.delete({
              'calendarId': CAL_ID,
              'eventId': event.id
            }));
          }
          batch2.then(function () {
            console.log('Usunieto wszystko');
          });
        }
      });
    }



    //funkcja do mieszania tablicy
    function shuffle(array) {
      var currentIndex = array.length, temporaryValue, randomIndex;

      // While there remain elements to shuffle...
      while (0 !== currentIndex) {

        // Pick a remaining element...
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex -= 1;

        // And swap it with the current element.
        temporaryValue = array[currentIndex];
        array[currentIndex] = array[randomIndex];
        array[randomIndex] = temporaryValue;
      }

      return array;
    }

  </script>

  <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
</body>

</html>
